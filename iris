pipeline {
  agent any

  stages {
    stage('Deploy to EC2') {
      steps {
        sh '''
          ssh -o StrictHostKeyChecking=no ec2-user@<EC2_PUBLIC_IP> << 'ENDSSH'
            mkdir -p ~/iris-app
            cd ~/iris-app

            if [ -d ".git" ]; then
              git pull origin master
            else
              git clone https://github.com/etichiranjeevi/IRIS-Flower-Classification.git .
            fi

            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate

            pip install --upgrade pip
            pip install -r requirements.txt

            pkill -f "python app.py" || true
            nohup python app.py > app.log 2>&1 &
          ENDSSH
        '''
      }
    }
  }
}
